<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Property Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
        }
        .card {
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        .table th {
            background-color: #f8f9fa;
        }
        .status-pending {
            color: #dc3545;
            font-weight: bold;
        }
        .status-not-pending {
            color: #28a745;
            font-weight: bold;
        }
        .status-paid {
            color: #17a2b8;
            font-weight: bold;
        }
        .status-vacant {
            color: #6c757d;
            font-weight: bold;
        }
        .payment-cash {
            color: #28a745;
            font-weight: bold;
        }
        .payment-cheque {
            color: #007bff;
            font-weight: bold;
        }
        .action-buttons {
            white-space: nowrap;
        }
        .qr-code {
            width: 80px;
            height: 80px;
            cursor: pointer;
        }
        .modal-qr {
            text-align: center;
            padding: 20px;
        }
        .month-selector {
            max-width: 200px;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center mb-4">Property Management</h1>
        
        <!-- Add Property Form -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>Add/Edit Property</h5>
            </div>
            <div class="card-body">
                <form id="propertyForm">
                    <input type="hidden" id="propertyId">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="propertyName" class="form-label">Property Name*</label>
                            <input type="text" class="form-control" id="propertyName" required>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="monthlyRent" class="form-label">Monthly Rent*</label>
                            <div class="input-group">
                                <span class="input-group-text">QR</span>
                                <input type="number" class="form-control" id="monthlyRent" min="0" step="0.01" required>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="status" class="form-label">Status*</label>
                            <select class="form-select" id="status" required>
                                <option value="">Select Status</option>
                                <option value="Pending">Pending</option>
                                <option value="Paid">Paid</option>
                                <option value="Vacant">Vacant</option>
                            </select>
                        </div>
                        <div class="col-md-2 mb-3">
                            <label for="paymentMethod" class="form-label">Payment Method</label>
                            <select class="form-select" id="paymentMethod">
                                <option value="">Select Method</option>
                                <option value="CASH">CASH</option>
                                <option value="CHEQUE">CHEQUE</option>
                            </select>
                        </div>
                        <div class="col-md-2 mb-3 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary me-2" id="saveBtn">Save</button>
                            <button type="button" class="btn btn-outline-secondary" id="cancelEdit" style="display:none;">Cancel</button>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="month" class="form-label">Month</label>
                            <select class="form-select month-selector" id="month">
                                <option value="">All months</option>
                                <option value="January">January</option>
                                <option value="February">February</option>
                                <option value="March">March</option>
                                <option value="April">April</option>
                                <option value="May">May</option>
                                <option value="June">June</option>
                                <option value="July">July</option>
                                <option value="August">August</option>
                                <option value="September">September</option>
                                <option value="October">October</option>
                                <option value="November">November</option>
                                <option value="December">December</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Search and Property List -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5>Property List</h5>
                <div class="d-flex">
                    <input type="text" class="form-control me-2" id="searchInput" placeholder="Search properties...">
                    <button class="btn btn-outline-danger" id="clearSearch">Clear</button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Property</th>
                                <th>Rent</th>
                                <th>Status</th>
                                <th>Payment Method</th>
                                <th>Month</th>
                                <th>QR Code</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="propertyTable">
                            <!-- Properties will be listed here -->
                        </tbody>
                    </table>
                </div>
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div id="propertyCount">0 properties found</div>
                    <div>
                        <button class="btn btn-sm btn-outline-success me-2" id="exportExcelBtn">Export to Excel</button>
                        <button class="btn btn-sm btn-outline-secondary me-2" id="exportJsonBtn">Export to JSON</button>
                        <button class="btn btn-sm btn-outline-primary" id="importBtn">Import Data</button>
                        <input type="file" id="fileInput" accept=".json,.xlsx,.xls,.csv" style="display: none;">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- QR Code Modal -->
    <div class="modal fade" id="qrModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="qrModalLabel">Property QR Code</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body modal-qr">
                    <div id="qrCodeDisplay"></div>
                    <p class="mt-3" id="qrPropertyInfo"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="downloadQR">Download</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const propertyForm = document.getElementById('propertyForm');
            const propertyTable = document.getElementById('propertyTable');
            const searchInput = document.getElementById('searchInput');
            const clearSearchBtn = document.getElementById('clearSearch');
            const cancelEditBtn = document.getElementById('cancelEdit');
            const saveBtn = document.getElementById('saveBtn');
            const exportExcelBtn = document.getElementById('exportExcelBtn');
            const exportJsonBtn = document.getElementById('exportJsonBtn');
            const importBtn = document.getElementById('importBtn');
            const fileInput = document.getElementById('fileInput');
            const propertyCount = document.getElementById('propertyCount');
            const monthSelector = document.getElementById('month');
            const qrModal = new bootstrap.Modal(document.getElementById('qrModal'));
            const qrCodeDisplay = document.getElementById('qrCodeDisplay');
            const qrPropertyInfo = document.getElementById('qrPropertyInfo');
            const downloadQRBtn = document.getElementById('downloadQR');
            
            let properties = JSON.parse(localStorage.getItem('properties')) || [];
            let editId = null;
            let currentFilter = null;
            let currentQRCode = null;

            // Initialize the app
            init();

            function init() {
                renderProperties();
                setupEventListeners();
            }

            function setupEventListeners() {
                propertyForm.addEventListener('submit', handleFormSubmit);
                searchInput.addEventListener('input', handleSearch);
                clearSearchBtn.addEventListener('click', clearSearch);
                cancelEditBtn.addEventListener('click', cancelEdit);
                exportExcelBtn.addEventListener('click', exportToExcel);
                exportJsonBtn.addEventListener('click', exportToJson);
                importBtn.addEventListener('click', () => fileInput.click());
                fileInput.addEventListener('change', importData);
                monthSelector.addEventListener('change', filterByMonth);
                downloadQRBtn.addEventListener('click', downloadQRCode);
            }

            function handleFormSubmit(e) {
                e.preventDefault();
                
                const propertyName = document.getElementById('propertyName').value.trim();
                const monthlyRent = parseFloat(document.getElementById('monthlyRent').value);
                const status = document.getElementById('status').value;
                const paymentMethod = document.getElementById('paymentMethod').value;
                const month = document.getElementById('month').value || 'Not specified';
                
                if (editId !== null) {
                    // Update existing property
                    const index = properties.findIndex(p => p.id === editId);
                    if (index !== -1) {
                        properties[index] = {
                            ...properties[index],
                            name: propertyName,
                            rent: monthlyRent,
                            status: status,
                            paymentMethod: paymentMethod,
                            month: month,
                            updatedAt: new Date().toISOString()
                        };
                        showAlert('Property updated successfully!', 'success');
                    }
                    cancelEdit();
                } else {
                    // Add new property
                    const newProperty = {
                        id: Date.now(),
                        name: propertyName,
                        rent: monthlyRent,
                        status: status,
                        paymentMethod: paymentMethod,
                        month: month,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    properties.push(newProperty);
                    showAlert('Property added successfully!', 'success');
                }
                
                saveProperties();
                propertyForm.reset();
                monthSelector.value = '';
                renderProperties(currentFilter);
            }

            function renderProperties(filteredProperties = null) {
                const propertiesToRender = filteredProperties || properties;
                
                propertyTable.innerHTML = propertiesToRender.map(property => `
                    <tr>
                        <td>${property.name}</td>
                        <td>${property.rent.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td class="status-${property.status.toLowerCase().replace(' ', '-')}">${property.status}</td>
                        <td class="${property.paymentMethod ? 'payment-' + property.paymentMethod.toLowerCase() : ''}">
                            ${property.paymentMethod || '-'}
                        </td>
                        <td>${property.month || '-'}</td>
                        <td>
                            <div class="qr-code" data-id="${property.id}" 
                                 data-info="${property.name} - ${property.rent} - ${property.status}">
                                <div id="qr-${property.id}"></div>
                            </div>
                        </td>
                        <td class="action-buttons">
                            <button class="btn btn-sm btn-warning me-2 edit-btn" data-id="${property.id}">Edit</button>
                            <button class="btn btn-sm btn-danger delete-btn" data-id="${property.id}">Delete</button>
                        </td>
                    </tr>
                `).join('');

                // Update property count
                propertyCount.textContent = `${propertiesToRender.length} ${propertiesToRender.length === 1 ? 'property' : 'properties'} found`;
                
                // Add event listeners to edit and delete buttons
                document.querySelectorAll('.edit-btn').forEach(btn => {
                    btn.addEventListener('click', () => handleEdit(parseInt(btn.getAttribute('data-id'))));
                });
                
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', () => handleDelete(parseInt(btn.getAttribute('data-id'))));
                });

                // Generate QR codes
                propertiesToRender.forEach(property => {
                    const qrContainer = document.getElementById(`qr-${property.id}`);
                    if (qrContainer) {
                        qrContainer.innerHTML = '';
                        new QRCode(qrContainer, {
                            text: `${property.name}\n${property.rent}\nStatus: ${property.status}\nPayment: ${property.paymentMethod || 'Not specified'}\nMonth: ${property.month || 'Not specified'}`,
                            width: 80,
                            height: 80,
                            colorDark: "#000000",
                            colorLight: "#ffffff",
                            correctLevel: QRCode.CorrectLevel.H
                        });
                    }
                });

                // Add click event to QR codes
                document.querySelectorAll('.qr-code').forEach(qr => {
                    qr.addEventListener('click', () => showQRModal(
                        parseInt(qr.getAttribute('data-id')),
                        qr.getAttribute('data-info')
                    ));
                });
            }

            function showQRModal(id, info) {
                const property = properties.find(p => p.id === id);
                if (!property) return;
                
                qrCodeDisplay.innerHTML = '';
                currentQRCode = new QRCode(qrCodeDisplay, {
                    text: `${property.name}\n${property.rent}\nStatus: ${property.status}\nPayment: ${property.paymentMethod || 'Not specified'}\nMonth: ${property.month || 'Not specified'}`,
                    width: 200,
                    height: 200,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
                
                qrPropertyInfo.textContent = info;
                qrModal.show();
            }

            function downloadQRCode() {
                const canvas = qrCodeDisplay.querySelector('canvas');
                if (!canvas) return;
                
                const link = document.createElement('a');
                link.download = `property-qr-${qrPropertyInfo.textContent.split(' - ')[0]}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            }

            function handleEdit(id) {
                const property = properties.find(p => p.id === id);
                
                if (property) {
                    document.getElementById('propertyId').value = property.id;
                    document.getElementById('propertyName').value = property.name;
                    document.getElementById('monthlyRent').value = property.rent;
                    document.getElementById('status').value = property.status;
                    document.getElementById('paymentMethod').value = property.paymentMethod || '';
                    document.getElementById('month').value = property.month || '';
                    
                    editId = property.id;
                    saveBtn.textContent = 'Update';
                    cancelEditBtn.style.display = 'inline-block';
                    
                    // Scroll to form
                    document.getElementById('propertyForm').scrollIntoView({ behavior: 'smooth' });
                }
            }

            function handleDelete(id) {
                if (confirm('Are you sure you want to delete this property?')) {
                    properties = properties.filter(p => p.id !== id);
                    saveProperties();
                    renderProperties(currentFilter);
                    
                    // If deleting the property being edited, reset form
                    if (editId === id) {
                        cancelEdit();
                    }
                    
                    showAlert('Property deleted successfully!', 'success');
                }
            }

            function handleSearch() {
                const searchTerm = this.value.toLowerCase();
                currentFilter = properties.filter(property => 
                    property.name.toLowerCase().includes(searchTerm) ||
                    property.rent.toString().includes(searchTerm) ||
                    property.status.toLowerCase().includes(searchTerm) ||
                    (property.paymentMethod && property.paymentMethod.toLowerCase().includes(searchTerm)) ||
                    (property.month && property.month.toLowerCase().includes(searchTerm))
                );
                renderProperties(currentFilter);
            }

            function filterByMonth() {
                const month = this.value;
                if (!month) {
                    currentFilter = null;
                    renderProperties();
                    return;
                }
                
                currentFilter = properties.filter(property => 
                    property.month && property.month.toLowerCase() === month.toLowerCase()
                );
                renderProperties(currentFilter);
            }

            function clearSearch() {
                searchInput.value = '';
                monthSelector.value = '';
                currentFilter = null;
                renderProperties();
            }

            function cancelEdit() {
                propertyForm.reset();
                monthSelector.value = '';
                editId = null;
                saveBtn.textContent = 'Save';
                cancelEditBtn.style.display = 'none';
            }

            function saveProperties() {
                localStorage.setItem('properties', JSON.stringify(properties));
            }

            function exportToExcel() {
                // Prepare data for Excel export
                const dataToExport = (currentFilter || properties).map(property => ({
                    'Property Name': property.name,
                    'Monthly Rent': property.rent,
                    'Status': property.status,
                    'Payment Method': property.paymentMethod || 'Not specified',
                    'Month': property.month || 'Not specified',
                    'Created At': new Date(property.createdAt).toLocaleString(),
                    'Updated At': new Date(property.updatedAt).toLocaleString()
                }));

                // Create worksheet
                const ws = XLSX.utils.json_to_sheet(dataToExport);
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Properties");
                
                // Export to Excel file
                const fileName = `properties_${new Date().toISOString().slice(0,10)}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                showAlert('Data exported to Excel successfully!', 'success');
            }

            function exportToJson() {
                const dataStr = JSON.stringify(currentFilter || properties, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = `properties-${new Date().toISOString().slice(0,10)}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                
                showAlert('Data exported to JSON successfully!', 'success');
            }

            function importData(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                if (confirm('Importing data will overwrite your current properties. Continue?')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            let importedData;
                            
                            if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                                // Handle Excel file
                                const data = new Uint8Array(e.target.result);
                                const workbook = XLSX.read(data, { type: 'array' });
                                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                                importedData = XLSX.utils.sheet_to_json(firstSheet);
                                
                                // Convert Excel data to our property format
                                importedData = importedData.map(item => ({
                                    id: Date.now() + Math.floor(Math.random() * 1000),
                                    name: item['Property Name'] || '',
                                    rent: item['Monthly Rent'] || 0,
                                    status: item['Status'] || 'Pending',
                                    paymentMethod: item['Payment Method'] || '',
                                    month: item['Month'] || '',
                                    createdAt: new Date().toISOString(),
                                    updatedAt: new Date().toISOString()
                                }));
                            } else {
                                // Handle JSON file
                                importedData = JSON.parse(e.target.result);
                            }
                            
                            if (Array.isArray(importedData)) {
                                properties = importedData;
                                saveProperties();
                                renderProperties();
                                showAlert('Data imported successfully!', 'success');
                            } else {
                                throw new Error('Invalid data format');
                            }
                        } catch (error) {
                            showAlert('Error importing data. Please check the file format.', 'danger');
                            console.error(error);
                        }
                    };
                    
                    if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                        reader.readAsArrayBuffer(file);
                    } else {
                        reader.readAsText(file);
                    }
                }
                
                // Reset file input
                fileInput.value = '';
            }

            function showAlert(message, type) {
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3`;
                alertDiv.setAttribute('role', 'alert');
                alertDiv.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                
                document.body.appendChild(alertDiv);
                
                // Auto-remove after 3 seconds
                setTimeout(() => {
                    alertDiv.classList.remove('show');
                    setTimeout(() => alertDiv.remove(), 150);
                }, 3000);
            }
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>